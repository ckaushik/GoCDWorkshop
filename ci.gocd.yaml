environments:
  docker:
    environment_variables:
      DOCKERHUB_USER: kaushikc
    pipelines:
      - package

pipelines:
  compile:
    group: contacts-app
    materials:
      mygit:  # this is the name of material
        # says about type of material and url at once
        git: https://github.com/ckaushik/contacts-ui.git
    stages:
      - build: # name of stage
          jobs:
            build: # name of the job
              tasks:
                - exec: # indicates type of task
                   command: bash
                   arguments:
                     - "-c"
                     - "yarn install --production && yarn build"
              artifacts:
                - build:
                    source: build
              resources:
                - yarn
  package:
    group: contacts-app
    materials:
      compilation:
        pipeline: compile
        stage: build
      mygit:
        git: https://github.com/ckaushik/contacts-ui.git
    stages:
      - build: # name of stage
          jobs:
            build: # name of the job
              tasks:
                - fetch:
                   pipeline: compile
                   stage: build
                   job: build
                   source: build
                - exec: # indicates type of task
                   command: bash
                   arguments:
                     - "-c"
                     - "docker build -t contacts-ui:${GO_PIPELINE_LABEL} -f Dockerfile.build ."
                - exec: # indicates type of task
                   command: bash
                   arguments:
                     - "-c"
                     - "echo contacts-ui:${GO_PIPELINE_LABEL} > contacts-ui-version.txt"
              artifacts:
                - build:
                    source: contacts-ui-version.txt
              resources:
                - docker
      - publish:
          jobs:
            publish:
              tasks:
                - fetch:
                   stage: build
                   job: build
                   is_file: yes
                   source: contacts-ui-version.txt
                - exec:
                   command: bash
                   arguments:
                     - "-c"
                     - "docker tag `cat contacts-ui-version.txt` ${DOCKERHUB_USER}/`cat contacts-ui-version.txt`"
                - exec:
                   command: bash
                   arguments:
                     - "-c"
                     - "docker push ${DOCKERHUB_USER}/`cat contacts-ui-version.txt`"
              resources:
                - docker
  deploy:
    group: contacts-app
    materials:
      compilation:
        pipeline: package
        stage: build
      mygit:
        git: https://github.com/ckaushik/contacts-ui.git
    stages:
      - deploy:
          jobs:
            build:
              tasks:
                - fetch:
                   pipeline: package
                   stage: build
                   job: build
                   source: contacts-ui-version.txt
                - exec:
                   command: bash
                   arguments:
                     - "-c"
                     - "kubectl apply -f deployment.yaml"
              resources:
                - deployer
